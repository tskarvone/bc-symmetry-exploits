%%%%%%%%%
%%%
%%%  EXAMPLE 1:
%%%  Gauss-Hermite sparse grid kernel quadrature on a zero
%%%  coupon bond model. Integration in dimensions 9 to 299.
%%%  Both the standard sparse grid Bayesian cubature and 
%%%  Bayes-Sard cubature are used.
%%%
%%% Toni Karvonen, 2017-2018
%%%
%%%%%%%%%

  clear all
  close all

  %% Initializations
    addpath('../functions')

    % Permanent parameters
    T = 5;
    kappa = 0.1817303;
    theta = 0.0825398957;
    sigma = 0.0125901;
    r0 = 0.021673;
    isotropic = true;
    dist = 'normal';
    
    % BSC parameters
    r = 2;
    
    % Seed for MC reproducibility
    rng(9798)
    
  %% Select and loop over the dimensions
    dims = [10:2:100 105:5:300];
    Qs   = [];    % Bayesian cubature integral estimates
    Q2s  = [];    % Bayes-Sard cubature integral estimates
    wces = [];
    Ns   = [];
    zcbs = [];    % True integral values
    MCs  = [];    % Monte Carlo integral estimates
  
    for d = dims
       
      D = d - 1;
    
      % The true solution
      zcb = zcb_true(kappa, theta, sigma, r0, T, d);
      zcbs = [zcbs zcb];
      
      % Generate the sparse grid (this is the most time-consuming part)
      q  = 2;
      XS = gh_seq(q);
      us = sparse_gens(XS, D);
      us = us(:,2:end); % We do not want the central point
      [Us Ls] = fss_gen(us, D);

      % Integrand evaluations
      Y = zcb_integrand(cell2mat(Us), kappa, theta, sigma, r0, T);    
      
      % Sparse grid kernel quadrature
      %l  = sqrt(d);   % Select depending on the experiment
      l = d;         %
      [k kmean Ikmean] = kq_kernel('gauss', l, D, dist);
      [Q, wce, wr] = kq_fss(Y, Us, k, kmean, Ikmean,isotropic);
      Qs = [Qs Q];
      wces = [wces wce];
      N = sum(Ls);
      Ns = [Ns N];
      
      % Sparse grid Bayes-Sard cubature
      Q2 = bsc_fss(Y, Us, k, kmean, Ikmean, r, dist, isotropic);
      Q2s = [Q2s Q2];
      
      % Standard MC
      X = randn(D, N);
      Y = zcb_integrand(X, kappa, theta, sigma, r0, T);
      MC = sum(Y)/N;
      MCs = [MCs MC];
      
      % Tell where we are at the moment
      fprintf('Dimension = %i\n', d);
      
    end
  
  %% Plot
  
    subplot(311)
    plot(dims, Qs, dims, Q2s, dims, MCs, dims, zcbs, '--')
    legend('BC', 'BSC', 'MC', 'Ground truth')
    title('Integral values')

    relErr = abs(Qs - zcbs)./zcbs;
    relErr2 = abs(Q2s - zcbs)./zcbs;
    relErrMC = abs(MCs - zcbs)./zcbs;
    
    subplot(312)
    semilogy(dims, relErr, dims, relErr2, dims, relErrMC)
    legend('BC', 'BSC', 'MC')
    title('Relative error')  

